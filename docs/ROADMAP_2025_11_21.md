# Project Roadmap & Status Update
**Date**: 2025-11-21
**Current Branch**: `claude/update-docs-roadmap-01FonNVg47CwKQJaXpR6fmEt`
**Last Completed Phase**: 114

---

## Current Project Status

### Performance Metrics
- **Current Benchmark**: 4.62s average (4.30-4.90s range over 3 runs)
- **Target**: ‚â§4.33s (‚â§3% from 4.20s baseline)
- **Status**: ‚ö†Ô∏è **SLIGHTLY ABOVE TARGET** (~9% over baseline)
- **Historical Baseline**: 2.17s (different hardware)

### Code Quality Metrics
- **Coverage**: 96.1% lines, 92.7% functions, 85.2% branches ‚úÖ
- **Build Status**: Zero warnings with `-Werror` ‚úÖ
- **Tests**: All passing ‚úÖ
- **CI/CD**: Active (Phase 101 complete) ‚úÖ

### Modernization Progress
- **Classes**: 19/19 fully encapsulated (100%) ‚úÖ
- **Macros**: ~500 converted (~37% of convertible)
- **Enum Classes**: All major enums converted ‚úÖ
- **CRTP**: Active across all 9 GC types ‚úÖ
- **Exceptions**: Modern C++ (replaced setjmp/longjmp) ‚úÖ

---

## Recently Completed Phases (112-114)

### Phase 112: Type Safety & std::span Integration (Multi-part)
**Status**: ‚úÖ COMPLETE
**Commits**: f53cd37, 4533793, e5d33b0, 7ddb44e, 393c6ee

**Phase 112.0**: std::span Accessors to Proto and ProtoDebugInfo
- Added `getCodeSpan()`, `getConstantsSpan()`, `getProtosSpan()`, `getUpvaluesSpan()`
- Added debug info span accessors (lineinfo, abslineinfo, locvars)
- Zero-cost abstraction: inline constexpr methods
- **Files**: `src/objects/lobject.h`

**Phase 112.1**: Fix Clang Sign-Conversion Errors
- Fixed sign-conversion warnings in std::span accessors
- Ensured Clang 15+ compatibility
- **Files**: Multiple accessor methods

**Phase 112 Part 1**: Operator Type Safety
- Converted `FuncState::prefix(int op)` ‚Üí `prefix(UnOpr op)`
- Converted `FuncState::infix(int op)` ‚Üí `infix(BinOpr op)`
- Converted `FuncState::posfix(int op)` ‚Üí `posfix(BinOpr op)`
- **Impact**: Eliminated 6 redundant static_cast operations
- **Files**: `lparser.h`, `lcode.cpp`, `parser.cpp`

**Phase 112 Part 2**: InstructionView Encapsulation
- Added opcode property methods to InstructionView:
  - `getOpMode()`, `testAMode()`, `testTMode()`
  - `testITMode()`, `testOTMode()`, `testMMMode()`
- Encapsulated `luaP_opmodes` array access
- **Impact**: Better encapsulation, cleaner code
- **Files**: `lopcodes.h`, `lopcodes.cpp`, `lcode.cpp`, `ldebug.cpp`

**Phase 112 (Final)**: Loop Variable Type Optimization
- Optimized loop counter types for type safety
- **Performance**: 4.33s avg (exactly at target!) üéØ

**Overall Phase 112 Impact**:
- Type safety improved significantly
- std::span integration begun (Proto arrays)
- Operator handling modernized
- Performance: Within target

---

### Phase 113: Boolean Predicates & Loop Modernization (Dual Focus)
**Status**: ‚úÖ COMPLETE
**Commits**: c0b91a2, 56fa457

**Phase 113a**: Modernize Loops with C++ Standard Algorithms
- Converted traditional loops to range-based for loops
- Used C++20/23 algorithms where beneficial
- Improved code readability
- **Files**: Multiple (compiler, VM, GC modules)

**Phase 113b**: Convert Internal Predicates to bool Return Type
- Converted 7 functions from `int` (0/1) to `bool`:
  1. `isKint()` - lcode.cpp
  2. `isCint()` - lcode.cpp
  3. `isSCint()` - lcode.cpp
  4. `isSCnumber()` - lcode.cpp
  5. `validop()` - lcode.cpp
  6. `testobjref1()` - ltests.cpp
  7. `testobjref()` - ltests.cpp
- **Impact**: Clearer intent, prevents arithmetic on booleans
- **Performance**: 4.73s avg (within normal variance)

**Overall Phase 113 Impact**:
- Modern loop patterns adopted
- Type safety improved (bool vs int)
- Code clarity enhanced

---

### Phase 114: NULL to nullptr Modernization
**Status**: ‚úÖ COMPLETE
**Commit**: aa61f96

**Changes**:
- Replaced all C-style `NULL` macros with C++11 `nullptr`
- Improved type safety (nullptr has its own type)
- Modern C++ best practice
- **Files**: Codebase-wide (systematic replacement)

**Impact**:
- Full C++11+ compliance
- Better type checking
- Prevents implicit conversions
- Zero performance impact

---

## Unfinished/Incomplete Work Assessment

### ‚úÖ No Unfinished Phases Detected

All recent phases (112-114) are complete and merged. No abandoned or partial work found.

### ‚ö†Ô∏è Performance Slightly Above Target

**Current**: 4.62s avg (target ‚â§4.33s)
**Variance**: 4.30-4.90s range indicates run-to-run variability
**Action**: Monitor; may need micro-optimizations if consistently above 4.33s

---

## Planned/Documented Work (Not Yet Started)

### From SPAN_MODERNIZATION_PLAN.md
**Status**: Phase 112 started span work, but plan shows 11 phases
**Completed**: Phase 1-2 (Foundation, Proto code/constants)
**Remaining**: Phases 3-11 (Proto nested protos, upvalues, debug info, Table, buffers, function params, strings, testing)

**Assessment**: Partial implementation. Proto has span accessors, but:
- Table array span accessors not yet added
- Buffer (Mbuffer, Zio) span accessors not added
- Function parameter conversions not done
- TString span accessors not added

**Recommendation**: Continue span adoption in Phase 115+

---

### From TYPE_MODERNIZATION_ANALYSIS.md
**Status**: Analysis complete, some work done

**Completed**:
- ‚úÖ Operator type safety (Phase 112)
- ‚úÖ 7 boolean conversions (Phase 113)

**Remaining High-Value Work**:
1. **8 Boolean Return Conversions** (2 hours, LOW risk)
   - `iscleared()` - gc/gc_weak.cpp
   - `hashkeyisempty()` - ltable.cpp
   - `finishnodeset()`, `rawfinishnodeset()` - ltable.cpp
   - `check_capture()` - lstrlib.cpp
   - `isneg()` - lobject.cpp
   - `checkbuffer()` - lzio.cpp
   - `test2()` - liolib.cpp

**Not Recommended** (per analysis):
- ‚ùå Loop counter conversions (int ‚Üí size_t) - 400 instances, high effort, low value
- ‚ùå Size variable conversions - HIGH underflow risk
- ‚ùå Register index strong types - Very invasive
- ‚ùå Status code enum class - C API constraint
- ‚ùå Token type modernization - Current design works well

---

### From LOOP_OPTIMIZATION_ANALYSIS.md
**Status**: Analysis complete, minimal action needed

**Findings**:
- Overall loop quality: EXCELLENT ‚úÖ
- 88% of loops are type-safe
- Only 1 hot-path micro-optimization identified

**Recommended Actions** (Tier 1-2):
1. `lvm.cpp:808` - OP_LOADNIL loop optimization (micro-opt)
2. Explicit casts for clarity (type safety)
3. Document intentional patterns

**Verdict**: Very low priority, already well-optimized

---

### From NEXT_TASKS_RECOMMENDATIONS.md
**Status**: Tasks 1-3 partially complete

**Completed**:
- ‚úÖ Task #1: CI/CD Infrastructure (Phase 101)
- ‚úÖ Task #2: Test Coverage Metrics (96.1% achieved)
- ‚ö†Ô∏è Task #3: Macro Conversions (500/~575 done = ~87% of target)

**High Priority Remaining**:
- **GC Modularization Documentation** - Phase 101+ work undocumented
- **Static Analysis Integration** - clang-tidy, cppcheck, iwyu
- **Complete Remaining Macro Conversions** (~75 macros)

**Medium Priority**:
- Performance profiling session
- Memory layout optimization
- Documentation enhancements

---

## Recommendations for Next Phases

### üéØ Immediate Priorities (Phase 115-117)

#### Phase 115: Complete Boolean Return Type Conversions ‚≠ê‚≠ê‚≠ê
**Effort**: 2 hours
**Risk**: LOW
**Value**: HIGH (completes modernization milestone)

Convert remaining 8 functions:
```cpp
// gc/gc_weak.cpp
static bool iscleared(global_State* g, const GCObject* o);

// ltable.cpp
static bool hashkeyisempty(Table* t, lua_Unsigned i);
static bool finishnodeset(Table* t, const TValue* key);
static bool rawfinishnodeset(Table* t, const TValue* key);

// lstrlib.cpp
static bool check_capture(MatchState* ms, int l);

// lobject.cpp
static bool isneg(const TValue* o);

// lzio.cpp
static bool checkbuffer(Zio* z);

// liolib.cpp
static bool test2(const char* s1, const char* s2);
```

**Success Criteria**:
- All internal predicates return bool
- Zero performance regression
- 15/15 boolean conversions complete

---

#### Phase 116: Document GC Modularization Achievement ‚≠ê‚≠ê
**Effort**: 2-3 hours
**Risk**: NONE (documentation only)
**Value**: HIGH (captures major work)

**Deliverable**: `docs/GC_MODULARIZATION_SUMMARY.md`

**Content**:
- Overview of extraction work (Phases 101+)
- Before/after metrics:
  - lgc.cpp: 1,950 ‚Üí 936 lines (52% reduction)
  - 6 modules extracted: gc_core, gc_marking, gc_collector, gc_sweeping, gc_finalizer, gc_weak
- Architecture improvements
- Performance impact
- Benefits for maintainability

**Why Important**:
- Similar to REFACTORING_SUMMARY.md (documents SRP work)
- Helps future contributors understand GC structure
- Completes the GC simplification story

---

#### Phase 117: Continue std::span Adoption ‚≠ê‚≠ê
**Effort**: 6-8 hours
**Risk**: LOW-MEDIUM
**Value**: MEDIUM-HIGH

Follow SPAN_MODERNIZATION_PLAN.md Phases 3-11:

**Phase 117a**: Table Array Span Accessors (3-4 hours)
- Add `getArraySpan()` to Table class
- Convert iteration over table arrays
- **CAREFUL**: Hot path, benchmark thoroughly

**Phase 117b**: Buffer Span Accessors (2-3 hours)
- Add span accessors to Mbuffer and Zio
- Modernize buffer operations in lexer

**Phase 117c**: TString Span Accessor (1 hour)
- Add `getStringSpan()` for const char* + length
- Consider `std::string_view` alternative

**Success Criteria**:
- Zero performance regression (‚â§4.33s)
- Improved type safety
- Cleaner APIs

---

### üîç Secondary Priorities (Phase 118-120)

#### Phase 118: Static Analysis Integration ‚≠ê‚≠ê
**Effort**: 3-4 hours
**Value**: MEDIUM-HIGH

**Tools**:
- clang-tidy - Modern C++ best practices
- cppcheck - Additional static analysis
- include-what-you-use - Header optimization

**Deliverables**:
- `.clang-tidy` configuration
- CI integration for automated checks
- Fix identified issues incrementally

---

#### Phase 119: Complete Remaining Macro Conversions ‚≠ê
**Effort**: 8-10 hours total
**Value**: MEDIUM

**Batches**:
1. lopcodes.h - Instruction manipulation (25 macros, 2-3 hours)
2. llimits.h - Utility macros (15 macros, 1-2 hours)
3. lctype.h - Character checks (10 macros, 1 hour)
4. Miscellaneous (15 macros, 2 hours)

**Success Criteria**:
- All convertible macros ‚Üí inline functions
- Zero performance regression
- Documented in CLAUDE.md

---

#### Phase 120: Address Performance Regression ‚≠ê‚≠ê
**Effort**: 4-6 hours (investigation + fixes)
**Value**: HIGH (back to target)

**Current Issue**: 4.62s avg vs 4.33s target (7% over)

**Approach**:
1. Profile with perf/cachegrind
2. Identify hot spots introduced in recent phases
3. Micro-optimize critical paths
4. Verify ‚â§4.33s achieved

**Likely Causes**:
- std::span overhead in hot paths (unlikely but check)
- InstructionView method calls (should be inline)
- Loop modernization patterns

---

### üìä Long-Term Work (Phase 121+)

#### Performance Optimization
- Full profiling session with perf/cachegrind
- Memory layout optimization (struct padding, cache lines)
- Link-time optimization (LTO) tuning
- Profile-guided optimization (PGO)

#### Documentation & Polish
- Architecture diagrams (Mermaid)
- CONTRIBUTING.md guide
- Code cleanup sweep (`[[nodiscard]]`, `[[maybe_unused]]`)
- Doxygen documentation

#### Advanced Modernization
- C++23 modules (when compiler support matures)
- Ranges library integration
- Coroutine integration for Lua coroutines
- std::expected for error handling

---

## Completed Plan Documents (Mark as Historical)

These plan documents are now complete and should be marked as historical reference:

1. ‚úÖ **ENCAPSULATION_PLAN.md** - Phases 37-42 complete
2. ‚úÖ **CONSTRUCTOR_PLAN.md** - Phases 1-2 complete
3. ‚úÖ **CONSTRUCTOR_REFACTOR_PLAN.md** - Constructor work complete
4. ‚úÖ **LUASTACK_AGGRESSIVE_PLAN.md** - Phase 94 complete
5. ‚úÖ **LUASTACK_ASSIGNMENT_PLAN.md** - Stack operations complete
6. ‚úÖ **PHASE_36_2_PLAN.md** - Historical
7. ‚úÖ **AGGRESSIVE_MACRO_ELIMINATION_PLAN.md** - Ongoing (37% done)
8. ‚ö†Ô∏è **SPAN_MODERNIZATION_PLAN.md** - Partially complete (Phases 1-2 done, 3-11 remain)

**Action**: Add "‚úÖ HISTORICAL - Completed [date]" header to completed plans

---

## Summary: Next Steps

### Immediate (This Week)
1. **Phase 115**: Complete 8 boolean return conversions (2 hours)
2. **Phase 116**: Document GC modularization (2-3 hours)
3. **Update CLAUDE.md**: Add Phases 112-114 documentation (1 hour)

### Short-Term (Next 2 Weeks)
4. **Phase 117**: Continue std::span adoption (6-8 hours)
5. **Phase 118**: Static analysis integration (3-4 hours)
6. **Phase 120**: Address performance regression (4-6 hours)

### Medium-Term (Next Month)
7. **Phase 119**: Complete macro conversions (8-10 hours)
8. Performance profiling and optimization
9. Documentation enhancements

---

## Success Metrics

### Phase 115-117 Goals
- ‚úÖ 15/15 boolean conversions complete
- ‚úÖ GC work documented
- ‚úÖ std::span adoption progressed (Table, buffers, strings)
- ‚úÖ Performance ‚â§4.33s restored
- ‚úÖ CLAUDE.md updated with Phases 112-114

### Overall Project Health
- **Encapsulation**: 100% complete ‚úÖ
- **Type Safety**: 90%+ (improving)
- **Performance**: Within 3% of baseline (target)
- **Code Quality**: 96%+ coverage, zero warnings ‚úÖ
- **CI/CD**: Active and comprehensive ‚úÖ

---

**Last Updated**: 2025-11-21
**Document Version**: 1.0
**Status**: Active Roadmap
